package gql

// This file will be automatically regenerated based on the schema, any resolver implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen version v0.17.78-dev

import (
	"context"
	"encoding/json"
	"fmt"

	"github.com/looplj/axonhub/internal/contexts"
	"github.com/looplj/axonhub/internal/ent"
	"github.com/looplj/axonhub/internal/ent/apikey"
	"github.com/looplj/axonhub/internal/ent/channel"
	"github.com/looplj/axonhub/internal/ent/project"
	"github.com/looplj/axonhub/internal/ent/request"
	"github.com/looplj/axonhub/internal/ent/user"
	"github.com/looplj/axonhub/internal/objects"
	"github.com/looplj/axonhub/internal/server/biz"
	"github.com/looplj/axonhub/internal/server/chat"
)

// CreateChannel is the resolver for the createChannel field.
func (r *mutationResolver) CreateChannel(ctx context.Context, input ent.CreateChannelInput) (*ent.Channel, error) {
	return r.channelService.CreateChannel(ctx, &input)
}

// UpdateChannel is the resolver for the updateChannel field.
func (r *mutationResolver) UpdateChannel(ctx context.Context, id objects.GUID, input ent.UpdateChannelInput) (*ent.Channel, error) {
	return r.channelService.UpdateChannel(ctx, id.ID, &input)
}

// UpdateChannelStatus is the resolver for the updateChannelStatus field.
func (r *mutationResolver) UpdateChannelStatus(ctx context.Context, id objects.GUID, status channel.Status) (*ent.Channel, error) {
	return r.channelService.UpdateChannelStatus(ctx, id.ID, status)
}

// DeleteChannel is the resolver for the deleteChannel field.
func (r *mutationResolver) DeleteChannel(ctx context.Context, id objects.GUID) (bool, error) {
	if err := r.channelService.DeleteChannel(ctx, id.ID); err != nil {
		return false, err
	}

	return true, nil
}

// BulkArchiveChannels is the resolver for the bulkArchiveChannels field.
func (r *mutationResolver) BulkArchiveChannels(ctx context.Context, ids []*objects.GUID) (bool, error) {
	channelIDs := objects.IntGuids(ids)

	if err := r.channelService.BulkArchiveChannels(ctx, channelIDs); err != nil {
		return false, err
	}

	return true, nil
}

// BulkDisableChannels is the resolver for the bulkDisableChannels field.
func (r *mutationResolver) BulkDisableChannels(ctx context.Context, ids []*objects.GUID) (bool, error) {
	channelIDs := objects.IntGuids(ids)

	if err := r.channelService.BulkDisableChannels(ctx, channelIDs); err != nil {
		return false, err
	}

	return true, nil
}

// BulkEnableChannels is the resolver for the bulkEnableChannels field.
func (r *mutationResolver) BulkEnableChannels(ctx context.Context, ids []*objects.GUID) (bool, error) {
	channelIDs := objects.IntGuids(ids)

	if err := r.channelService.BulkEnableChannels(ctx, channelIDs); err != nil {
		return false, err
	}

	return true, nil
}

// BulkDeleteChannels is the resolver for the bulkDeleteChannels field.
func (r *mutationResolver) BulkDeleteChannels(ctx context.Context, ids []*objects.GUID) (bool, error) {
	channelIDs := objects.IntGuids(ids)

	if err := r.channelService.BulkDeleteChannels(ctx, channelIDs); err != nil {
		return false, err
	}

	return true, nil
}

// TestChannel is the resolver for the testChannel field.
func (r *mutationResolver) TestChannel(ctx context.Context, input TestChannelInput) (*TestChannelPayload, error) {
	// Set test source context for test channel requests
	ctx = contexts.WithSource(ctx, request.SourceTest)

	processor := chat.NewTestChannelProcessor(r.channelService, r.requestService, r.systemService, r.httpClient, input.ChannelID)

	result, err := processor.TestChannel(ctx, input.ChannelID, input.ModelID)
	if err != nil {
		return nil, fmt.Errorf("failed to test channel: %w", err)
	}

	return &TestChannelPayload{
		Latency: result.Latency,
		Success: result.Success,
		Error:   result.Error,
	}, nil
}

// BulkImportChannels is the resolver for the bulkImportChannels field.
func (r *mutationResolver) BulkImportChannels(ctx context.Context, input BulkImportChannelsInput) (*BulkImportChannelsResult, error) {
	// Convert GraphQL input to biz layer input
	items := make([]biz.BulkImportChannelItem, len(input.Channels))
	for i, item := range input.Channels {
		items[i] = biz.BulkImportChannelItem{
			Type:             item.Type,
			Name:             item.Name,
			BaseURL:          item.BaseURL,
			APIKey:           item.APIKey,
			SupportedModels:  item.SupportedModels,
			DefaultTestModel: item.DefaultTestModel,
		}
	}

	result, err := r.channelService.BulkImportChannels(ctx, items)
	if err != nil {
		return nil, err
	}

	return &BulkImportChannelsResult{
		Success:  result.Success,
		Created:  result.Created,
		Failed:   result.Failed,
		Errors:   result.Errors,
		Channels: result.Channels,
	}, nil
}

// BulkUpdateChannelOrdering is the resolver for the bulkUpdateChannelOrdering field.
func (r *mutationResolver) BulkUpdateChannelOrdering(ctx context.Context, input BulkUpdateChannelOrderingInput) (*BulkUpdateChannelOrderingResult, error) {
	// Prepare updates for the service layer
	updates := make([]struct {
		ID             int
		OrderingWeight int
	}, len(input.Channels))

	for i, item := range input.Channels {
		updates[i] = struct {
			ID             int
			OrderingWeight int
		}{
			ID:             item.ID.ID,
			OrderingWeight: item.OrderingWeight,
		}
	}

	// Call the business logic layer
	updatedChannels, err := r.channelService.BulkUpdateChannelOrdering(ctx, updates)
	if err != nil {
		return nil, fmt.Errorf("failed to bulk update channel ordering: %w", err)
	}

	return &BulkUpdateChannelOrderingResult{
		Success:  true,
		Updated:  len(updatedChannels),
		Channels: updatedChannels,
	}, nil
}

// CreateAPIKey is the resolver for the createAPIKey field.
func (r *mutationResolver) CreateAPIKey(ctx context.Context, input ent.CreateAPIKeyInput) (*ent.APIKey, error) {
	return r.apiKeyService.CreateAPIKey(ctx, input)
}

// UpdateAPIKey is the resolver for the updateAPIKey field.
func (r *mutationResolver) UpdateAPIKey(ctx context.Context, id objects.GUID, input ent.UpdateAPIKeyInput) (*ent.APIKey, error) {
	return r.apiKeyService.UpdateAPIKey(ctx, id.ID, input)
}

// UpdateAPIKeyStatus is the resolver for the updateAPIKeyStatus field.
func (r *mutationResolver) UpdateAPIKeyStatus(ctx context.Context, id objects.GUID, status apikey.Status) (*ent.APIKey, error) {
	return r.apiKeyService.UpdateAPIKeyStatus(ctx, id.ID, status)
}

// UpdateAPIKeyProfiles is the resolver for the updateAPIKeyProfiles field.
func (r *mutationResolver) UpdateAPIKeyProfiles(ctx context.Context, id objects.GUID, input objects.APIKeyProfiles) (*ent.APIKey, error) {
	return r.apiKeyService.UpdateAPIKeyProfiles(ctx, id.ID, input)
}

// BulkDisableAPIKeys is the resolver for the bulkDisableAPIKeys field.
func (r *mutationResolver) BulkDisableAPIKeys(ctx context.Context, ids []*objects.GUID) (bool, error) {
	apiKeyIDs := objects.IntGuids(ids)

	err := r.apiKeyService.BulkDisableAPIKeys(ctx, apiKeyIDs)
	if err != nil {
		return false, err
	}

	return true, nil
}

// BulkArchiveAPIKeys is the resolver for the bulkArchiveAPIKeys field.
func (r *mutationResolver) BulkArchiveAPIKeys(ctx context.Context, ids []*objects.GUID) (bool, error) {
	apiKeyIDs := objects.IntGuids(ids)

	err := r.apiKeyService.BulkArchiveAPIKeys(ctx, apiKeyIDs)
	if err != nil {
		return false, err
	}

	return true, nil
}

// CreateUser is the resolver for the createUser field.
func (r *mutationResolver) CreateUser(ctx context.Context, input ent.CreateUserInput) (*ent.User, error) {
	return r.userService.CreateUser(ctx, input)
}

// UpdateUser is the resolver for the updateUser field.
func (r *mutationResolver) UpdateUser(ctx context.Context, id objects.GUID, input ent.UpdateUserInput) (*ent.User, error) {
	return r.userService.UpdateUser(ctx, id.ID, input)
}

// UpdateUserStatus is the resolver for the updateUserStatus field.
func (r *mutationResolver) UpdateUserStatus(ctx context.Context, id objects.GUID, status user.Status) (*ent.User, error) {
	return r.userService.UpdateUserStatus(ctx, id.ID, status)
}

// CreateRole is the resolver for the createRole field.
func (r *mutationResolver) CreateRole(ctx context.Context, input ent.CreateRoleInput) (*ent.Role, error) {
	return r.roleService.CreateRole(ctx, input)
}

// UpdateRole is the resolver for the updateRole field.
func (r *mutationResolver) UpdateRole(ctx context.Context, id objects.GUID, input ent.UpdateRoleInput) (*ent.Role, error) {
	return r.roleService.UpdateRole(ctx, id.ID, input)
}

// DeleteRole is the resolver for the deleteRole field.
func (r *mutationResolver) DeleteRole(ctx context.Context, id objects.GUID) (bool, error) {
	err := r.roleService.DeleteRole(ctx, id.ID)
	if err != nil {
		return false, err
	}

	return true, nil
}

// BulkDeleteRoles is the resolver for the bulkDeleteRoles field.
func (r *mutationResolver) BulkDeleteRoles(ctx context.Context, ids []*objects.GUID) (bool, error) {
	roleIDs := objects.IntGuids(ids)

	err := r.roleService.BulkDeleteRoles(ctx, roleIDs)
	if err != nil {
		return false, err
	}

	return true, nil
}

// CreateProject is the resolver for the createProject field.
func (r *mutationResolver) CreateProject(ctx context.Context, input ent.CreateProjectInput) (*ent.Project, error) {
	return r.projectService.CreateProject(ctx, input)
}

// UpdateProject is the resolver for the updateProject field.
func (r *mutationResolver) UpdateProject(ctx context.Context, id objects.GUID, input ent.UpdateProjectInput) (*ent.Project, error) {
	return r.projectService.UpdateProject(ctx, id.ID, input)
}

// UpdateProjectStatus is the resolver for the updateProjectStatus field.
func (r *mutationResolver) UpdateProjectStatus(ctx context.Context, id objects.GUID, status project.Status) (*ent.Project, error) {
	return r.projectService.UpdateProjectStatus(ctx, id.ID, status)
}

// AddUserToProject is the resolver for the addUserToProject field.
func (r *mutationResolver) AddUserToProject(ctx context.Context, input AddUserToProjectInput) (*ent.UserProject, error) {
	roleIDs := objects.IntGuids(input.RoleIDs)
	return r.userService.AddUserToProject(ctx, input.UserID.ID, input.ProjectID.ID, input.IsOwner, input.Scopes, roleIDs)
}

// RemoveUserFromProject is the resolver for the removeUserFromProject field.
func (r *mutationResolver) RemoveUserFromProject(ctx context.Context, input RemoveUserFromProjectInput) (bool, error) {
	err := r.userService.RemoveUserFromProject(ctx, input.UserID.ID, input.ProjectID.ID)
	if err != nil {
		return false, err
	}

	return true, nil
}

// UpdateProjectUser is the resolver for the updateProjectUser field.
func (r *mutationResolver) UpdateProjectUser(ctx context.Context, input UpdateProjectUserInput) (*ent.UserProject, error) {
	addRoleIDs := objects.IntGuids(input.AddRoleIDs)
	removeRoleIDs := objects.IntGuids(input.RemoveRoleIDs)

	return r.userService.UpdateProjectUser(ctx, input.UserID.ID, input.ProjectID.ID, input.Scopes, addRoleIDs, removeRoleIDs)
}

// CreateDataStorage is the resolver for the createDataStorage field.
func (r *mutationResolver) CreateDataStorage(ctx context.Context, input ent.CreateDataStorageInput) (*ent.DataStorage, error) {
	return r.dataStorageService.CreateDataStorage(ctx, &input)
}

// UpdateDataStorage is the resolver for the updateDataStorage field.
func (r *mutationResolver) UpdateDataStorage(ctx context.Context, id objects.GUID, input ent.UpdateDataStorageInput) (*ent.DataStorage, error) {
	return r.dataStorageService.UpdateDataStorage(ctx, id.ID, &input)
}

// FetchModels is the resolver for the fetchModels field.
func (r *queryResolver) FetchModels(ctx context.Context, input FetchModelsInput) (*FetchModelsPayload, error) {
	// Convert input to biz layer input
	bizInput := biz.FetchModelsInput{
		ChannelType: input.ChannelType,
		BaseURL:     input.BaseURL,
		APIKey:      input.APIKey,
	}

	if input.ChannelID != nil {
		bizInput.ChannelID = &input.ChannelID.ID
	}

	// Call the model fetcher service
	result, err := r.modelFetcher.FetchModels(ctx, bizInput)
	if err != nil {
		return nil, fmt.Errorf("failed to fetch models: %w", err)
	}

	// Convert result to GraphQL payload
	models := make([]*objects.ModelIdentify, len(result.Models))
	for i := range result.Models {
		models[i] = &result.Models[i]
	}

	return &FetchModelsPayload{
		Models: models,
		Error:  result.Error,
	}, nil
}

// Models is the resolver for the models field.
func (r *queryResolver) Models(ctx context.Context, status *channel.Status) ([]*Model, error) {
	// Build query for channels
	query := r.client.Channel.Query()

	// Apply status filter if provided, otherwise default to enabled
	if status != nil {
		query = query.Where(channel.StatusEQ(*status))
	} else {
		query = query.Where(channel.StatusEQ(channel.StatusEnabled))
	}

	// Get all channels matching the filter
	channels, err := query.All(ctx)
	if err != nil {
		return nil, fmt.Errorf("failed to query channels: %w", err)
	}

	// Collect all unique models from channels with their status
	modelMap := make(map[string]channel.Status)

	for _, ch := range channels {
		for _, modelID := range ch.SupportedModels {
			// Keep the highest priority status (enabled > disabled > archived)
			if existingStatus, exists := modelMap[modelID]; exists {
				if ch.Status == channel.StatusEnabled || (ch.Status == channel.StatusDisabled && existingStatus == channel.StatusArchived) {
					modelMap[modelID] = ch.Status
				}
			} else {
				modelMap[modelID] = ch.Status
			}
		}
	}

	// Convert map to slice
	models := make([]*Model, 0, len(modelMap))
	for modelID, status := range modelMap {
		models = append(models, &Model{
			ID:     modelID,
			Status: status,
		})
	}

	return models, nil
}

// ID is the resolver for the id field.
func (r *segmentResolver) ID(ctx context.Context, obj *biz.Segment) (*objects.GUID, error) {
	return &objects.GUID{Type: ent.TypeRequest, ID: obj.ID}, nil
}

// ParentID is the resolver for the parentId field.
func (r *segmentResolver) ParentID(ctx context.Context, obj *biz.Segment) (*objects.GUID, error) {
	if obj.ParentID == nil {
		return nil, nil
	}

	return &objects.GUID{Type: ent.TypeRequest, ID: *obj.ParentID}, nil
}

// FirstUserQuery is the resolver for the firstUserQuery field.
func (r *threadResolver) FirstUserQuery(ctx context.Context, obj *ent.Thread) (*string, error) {
	return r.threadService.FirstUserQuery(ctx, obj.ID)
}

// RootSegment is the resolver for the rootSegment field.
func (r *traceResolver) RootSegment(ctx context.Context, obj *ent.Trace) (*biz.Segment, error) {
	return r.traceService.GetRootSegment(ctx, obj.ID)
}

// RawRootSegment is the resolver for the rawRootSegment field.
func (r *traceResolver) RawRootSegment(ctx context.Context, obj *ent.Trace) (objects.JSONRawMessage, error) {
	segment, err := r.traceService.GetRootSegment(ctx, obj.ID)
	if err != nil {
		return nil, err
	}

	data, err := json.Marshal(segment)
	if err != nil {
		return nil, err
	}

	return objects.JSONRawMessage(data), nil
}

// FirstUserQuery is the resolver for the firstUserQuery field.
func (r *traceResolver) FirstUserQuery(ctx context.Context, obj *ent.Trace) (*string, error) {
	return r.traceService.FirstUserQuery(ctx, obj.ID)
}

// FirstText is the resolver for the firstText field.
func (r *traceResolver) FirstText(ctx context.Context, obj *ent.Trace) (*string, error) {
	return r.traceService.FirstText(ctx, obj.ID)
}

// Mutation returns MutationResolver implementation.
func (r *Resolver) Mutation() MutationResolver { return &mutationResolver{r} }

// Segment returns SegmentResolver implementation.
func (r *Resolver) Segment() SegmentResolver { return &segmentResolver{r} }

type mutationResolver struct{ *Resolver }
type segmentResolver struct{ *Resolver }
