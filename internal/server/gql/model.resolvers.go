package gql

// This file will be automatically regenerated based on the schema, any resolver
// implementations
// will be copied through when generating and any unknown code will be moved to the end.
// Code generated by github.com/99designs/gqlgen

import (
	"context"
	"fmt"

	"github.com/looplj/axonhub/internal/ent"
	"github.com/looplj/axonhub/internal/ent/model"
	"github.com/looplj/axonhub/internal/objects"
	"github.com/looplj/axonhub/internal/server/biz"
	"github.com/samber/lo"
)

// AssociatedChannelCount is the resolver for the associatedChannelCount field.
func (r *modelResolver) AssociatedChannelCount(ctx context.Context, obj *ent.Model) (int, error) {
	return r.modelService.CountAssociatedChannels(ctx, obj.Settings.Associations)
}

// CreateModel is the resolver for the createModel field.
func (r *mutationResolver) CreateModel(ctx context.Context, input ent.CreateModelInput) (*ent.Model, error) {
	return r.modelService.CreateModel(ctx, input)
}

// BulkCreateModels is the resolver for the bulkCreateModels field.
func (r *mutationResolver) BulkCreateModels(ctx context.Context, inputs []*ent.CreateModelInput) ([]*ent.Model, error) {
	return r.modelService.BulkCreateModels(ctx, inputs)
}

// UpdateModel is the resolver for the updateModel field.
func (r *mutationResolver) UpdateModel(ctx context.Context, id objects.GUID, input ent.UpdateModelInput) (*ent.Model, error) {
	return r.modelService.UpdateModel(ctx, id.ID, &input)
}

// DeleteModel is the resolver for the deleteModel field.
func (r *mutationResolver) DeleteModel(ctx context.Context, id objects.GUID) (bool, error) {
	if err := r.modelService.DeleteModel(ctx, id.ID); err != nil {
		return false, err
	}

	return true, nil
}

// UpdateModelStatus is the resolver for the updateModelStatus field.
func (r *mutationResolver) UpdateModelStatus(ctx context.Context, id objects.GUID, status model.Status) (bool, error) {
	_, err := r.modelService.UpdateModelStatus(ctx, id.ID, status)
	if err != nil {
		return false, err
	}

	return true, nil
}

// BulkArchiveModels is the resolver for the bulkArchiveModels field.
func (r *mutationResolver) BulkArchiveModels(ctx context.Context, ids []*objects.GUID) (bool, error) {
	modelIDs := objects.IntGuids(ids)

	if err := r.modelService.BulkArchiveModels(ctx, modelIDs); err != nil {
		return false, err
	}

	return true, nil
}

// BulkDisableModels is the resolver for the bulkDisableModels field.
func (r *mutationResolver) BulkDisableModels(ctx context.Context, ids []*objects.GUID) (bool, error) {
	modelIDs := objects.IntGuids(ids)

	if err := r.modelService.BulkDisableModels(ctx, modelIDs); err != nil {
		return false, err
	}

	return true, nil
}

// BulkEnableModels is the resolver for the bulkEnableModels field.
func (r *mutationResolver) BulkEnableModels(ctx context.Context, ids []*objects.GUID) (bool, error) {
	modelIDs := objects.IntGuids(ids)

	if err := r.modelService.BulkEnableModels(ctx, modelIDs); err != nil {
		return false, err
	}

	return true, nil
}

// BulkDeleteModels is the resolver for the bulkDeleteModels field.
func (r *mutationResolver) BulkDeleteModels(ctx context.Context, ids []*objects.GUID) (bool, error) {
	modelIDs := objects.IntGuids(ids)

	if err := r.modelService.BulkDeleteModels(ctx, modelIDs); err != nil {
		return false, err
	}

	return true, nil
}

// FetchModels is the resolver for the fetchModels field.
func (r *queryResolver) FetchModels(ctx context.Context, input biz.FetchModelsInput) (*FetchModelsPayload, error) {
	// Call the model fetcher service
	result, err := r.modelFetcher.FetchModels(ctx, input)
	if err != nil {
		return nil, fmt.Errorf("failed to fetch models: %w", err)
	}

	// Convert result to GraphQL payload
	models := make([]*biz.ModelIdentify, len(result.Models))
	for i := range result.Models {
		models[i] = &result.Models[i]
	}

	return &FetchModelsPayload{
		Models: models,
		Error:  result.Error,
	}, nil
}

// QueryModels is the resolver for the queryModels field.
// When QueryAllChannelModels is true, returns all models from channels.
// When false, returns only configured models (models with explicit Model entity configuration).
func (r *queryResolver) QueryModels(ctx context.Context, input QueryModelsInput) ([]*biz.ModelIdentityWithStatus, error) {
	// Check the QueryAllChannelModels setting
	settings := r.systemService.ModelSettingsOrDefault(ctx)

	if settings.QueryAllChannelModels {
		// Convert GraphQL input to biz layer input
		bizInput := biz.ListModelsInput{
			StatusIn:       input.StatusIn,
			IncludeMapping: lo.FromPtrOr(input.IncludeMapping, false),
			IncludePrefix:  lo.FromPtrOr(input.IncludePrefix, false),
		}

		// Return all models from channels
		return r.channelService.ListModels(ctx, bizInput)
	}

	// Return only configured models
	// Convert channel status to model status
	var modelStatusIn []model.Status

	if len(input.StatusIn) > 0 {
		for _, status := range input.StatusIn {
			modelStatusIn = append(modelStatusIn, model.Status(status.String()))
		}
	}

	return r.modelService.ListConfiguredModels(ctx, modelStatusIn)
}

// QueryModelChannelConnections is the resolver for the queryModelChannelConnections field.
func (r *queryResolver) QueryModelChannelConnections(ctx context.Context, associations []*objects.ModelAssociation) ([]*biz.ModelChannelConnection, error) {
	return r.modelService.QueryModelChannelConnections(ctx, associations)
}

// QueryUnassociatedChannels is the resolver for the queryUnassociatedChannels field.
func (r *queryResolver) QueryUnassociatedChannels(ctx context.Context) ([]*biz.UnassociatedChannel, error) {
	return r.modelService.QueryUnassociatedChannels(ctx)
}
