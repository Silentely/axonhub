# LLM Pipeline 架构概览

## 核心设计理念

AxonHub 的 LLM Pipeline 采用**转换器链（Transformer Chain）**模式，将不同 AI 提供商的 API 统一为标准的 OpenAI 兼容接口。

**核心思想**：所有请求经过"标准化 → 处理 → 反标准化"的流程，实现多提供商的无缝切换和智能路由。

---

## 数据模型

### 统一请求（LLMRequest）
兼容 OpenAI 格式，扩展支持：
- 多模态输入（文本、图像）
- 工具调用（函数调用）
- 推理努力控制（如 o1 系列）
- 缓存控制

### 统一响应（LLMResponse）
标准化输出，包含：
- 流式/非流式内容
- 使用统计（Token 消耗）
- 错误信息
- 完成原因

---

## 核心流程

### 阶段一：入站处理（标准化）

```
┌──────────────┐     ┌──────────────────┐     ┌─────────────────┐
│              │     │                  │     │                 │
│ 客户端请求    │────▶│ InboundTransformer│────▶│ 统一 LLM 请求    │
│ (OpenAI 格式) │     │  提取&标准化     │     │  (内部格式)     │
│              │     │                  │     │                 │
└──────────────┘     └──────────────────┘     └─────────────────┘
```

**关键步骤**：
1. **请求转换** - 解析 HTTP 请求并转换为内部 LLM 格式
2. **模型映射** - 根据 API Key Profile 映射模型名称（如 `gpt-4o` → `custom-model`）
3. **通道选择** - 基于健康状态和可用性选择合适的 AI 提供商通道
4. **持久化** - 创建请求记录，生成唯一 Request ID

---

### 阶段二：出站处理（反标准化）

```
┌─────────────────┐     ┌────────────────────┐     ┌──────────────────┐
│                 │     │                    │     │                  │
│ 统一 LLM 请求    │────▶│ OutboundTransformer│────▶│ 提供商特定请求    │
│  (内部格式)     │     │  转换&适配         │     │  (OpenAI/Claude等)│
│                 │     │                    │     │                  │
└─────────────────┘     └────────────────────┘     └──────────────────┘
```

**关键步骤**：
1. **格式转换** - 将统一格式转换为提供商特定格式（OpenAI、Anthropic、AI SDK）
2. **参数覆盖** - 应用通道配置中的覆盖参数（MaxTokens、温度等）
3. **HTTP 执行** - 发送请求到 AI 提供商
4. **响应转换** - 将提供商响应转换回统一格式

---

### 完整请求生命周期

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                             请求生命周期                                      │
│                                                                             │
│  1. 入站转换 (标准化)                                                        │
│      └─▶ 请求验证 → 模型映射 → 通道选择 → 创建记录                            │
│                                                                             │
│  2. 中间件处理 (可选)                                                        │
│      └─▶ MaxToken 限制 → 使用统计 → 请求日志                                │
│                                                                             │
│  3. 出站转换 (反标准化)                                                      │
│      └─▶ 格式转换 → 参数覆盖 → 准备 HTTP 请求                               │
│                                                                             │
│  4. Pipeline 执行（核心）                                                    │
│      ┌─────────────────────────────────────────────────────────────┐         │
│      │ 通道 1 (首选)                                                │         │
│      │   ├─▶ 发送请求 → 接收响应 → 处理结果                       │         │
│      │   └─▶ 失败？→ 判断重试策略 → 重试或切换通道               │         │
│      └─────────────────────────────────────────────────────────────┘         │
│                              ↓ (跨通道重试)                                 │
│      ┌─────────────────────────────────────────────────────────────┐         │
│      │ 通道 2 (备选)                                              │         │
│      │   └─▶ 重复上述流程                                       │         │
│      └─────────────────────────────────────────────────────────────┘         │
│                              ↓ (继续切换直到成功或耗尽)                       │
│                                                                             │
│  5. 响应处理                                                                 │
│      └─▶ 流式聚合 → 统计提取 → 记录完成状态 → 返回客户端                     │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 重试机制

### 智能错误处理

**两大重试策略**：

| 类型 | 触发条件 | 行为 |
|------|---------|------|
| **同通道重试** | 限流错误（429）、临时网络错误 | 等待后退时间后，同一通道重试 |
| **跨通道重试** | 通道不可用、模型不存在、认证失败 | 立即切换到下一个备选通道 |

**默认策略**：
- 最多 3 次尝试（初始 + 2 次重试）
- 限流错误采用指数退避（1s → 2s → 4s）
- 每次尝试都记录执行日志

---

## 流式响应

### 实时数据传输

```
提供商 SSE 流 → 转换器处理 → 统一格式块 → 转发到客户端
     ↓                                              ↑
     └──────→ 持久化存储 ←────── 块聚合 ←───────┘
```

**工作流程**：
1. **创建流** - 初始化流式响应记录
2. **逐块处理** - 每收到一块立即转换并转发
3. **实时聚合** - 在内存中累积内容，提取统计信息
4. **完成保存** - 流结束后保存聚合结果

**支持的流式协议**：
- OpenAI Server-Sent Events (SSE)
- Anthropic Event Stream
- AI SDK TextStream/DataStream

---

## Transformer 实现

### 支持的 AI 提供商

| 提供商 | InboundTransformer | OutboundTransformer | 特色功能 |
|--------|-------------------|--------------------|---------|
| **OpenAI** | OpenAI → 统一格式 | 统一格式 → OpenAI | 工具调用聚合、推理内容支持 |
| **Anthropic** | Claude → 统一格式 | 统一格式 → Claude | 系统消息合并、思考内容支持 |
| **AI SDK** | AI SDK → 统一格式 | 统一格式 → AI SDK | 兼容 Vercel AI SDK |

### 多平台支持

- **Azure OpenAI**：资源名称 + 部署 ID 特殊端点
- **AWS Bedrock**：AWS SigV4 认证，特殊事件格式
- **Google Vertex AI**：区域端点 + GCP 认证

---

## 中间件系统

### 可插拔的功能扩展

中间件在 Pipeline 执行前后介入，提供额外功能：

**内置中间件**：
1. **MaxToken 限制** - 限制单次请求的最大 Token 数
2. **使用统计** - 实时跟踪 Token 消耗
3. **请求日志** - 记录详细的请求响应信息
4. **通道切换** - 重试时自动切换通道

**中间件执行点**：
- 入站请求转换后
- 出站请求发送前
- 出站响应接收后
- 流式事件处理中

---

## 持久化机制

### 数据记录

**Request 记录**：
- 请求元数据（ID、时间、用户）
- 原始请求体（JSON）
- 使用的模型和通道

**执行记录（RequestExecution）**：
- 每次尝试的详细信息
- 通道配置快照
- 是否成功、错误信息

**流式块（StreamChunk）**：
- 每个 SSE 块实时保存
- 用于审计和调试

---

## 架构优势

### 1. 提供商无关性
- 统一接口屏蔽提供商差异
- 新增提供商只需实现 Transformer
- 客户端代码无需修改

### 2. 高可用性
- 自动故障转移（通道切换）
- 智能重试策略
- 健康检查和负载均衡

### 3. 可观测性
- 完整的请求链路追踪
- 详细的执行日志
- 实时使用统计

### 4. 可扩展性
- 中间件机制灵活扩展
- 配置驱动无需代码修改
- 支持自定义通道策略

---

## 快速入门

### 新手指南：Transformer 实现

1. **实现接口**（2 个文件）
   - `inbound.go` - 提供商格式 → 统一格式
   - `outbound.go` - 统一格式 → 提供商格式

2. **注册到工厂**
   ```go
   func init() {
       RegisterTransformer("myprovider", NewMyTransformer)
   }
   ```

3. **配置通道**
   - 在管理界面添加新通道
   - 选择提供商类型
   - 填写认证信息

---

## 架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           客户端请求                                  │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      HTTP Handler (/chat/completion)                  │
│                      文件: internal/server/api/chat.go               │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       ChatCompletionProcessor                         │
│                      文件: internal/server/chat/completion.go        │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│  InboundTransformer                                                    │
│  文件: internal/server/chat/inbound.go                               │
│  功能: HTTP Request → LLM Request                                    │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         中间件处理                                     │
│  - Model Mapping (模型名称映射)                                       │
│  - Channel Selection (通道选择)                                       │
│  - MaxToken Enforcement (Token 限制)                                 │
│  - Request Persistence (请求持久化)                                   │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│  OutboundTransformer                                                   │
│  文件: internal/server/chat/outbound.go                              │
│  功能: LLM Request → HTTP Request                                    │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        LLM Pipeline                                   │
│  文件: internal/llm/pipeline/pipeline.go                             │
│  功能: 执行请求 + 重试逻辑                                              │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│                Transformer (根据通道类型选择)                           │
│                                                                        │
│   ┌─────────────────┐        ┌─────────────────┐        ┌──────────┐│
│   │ OpenAI          │        │ Anthropic       │        │ AI SDK   ││
│   │ Transformers    │        │ Transformers    │        │Transform ││
│   └─────────────────┘        └─────────────────┘        └──────────┘│
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      AI 提供商 (OpenAI/Anthropic/...)                 │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│                Transformer (响应转换)                                  │
│                                                                        │
│  LLM Response ←─────────────────────┐                                 │
│                                      │                                │
│   ┌─────────────────┐        ┌──────▼──────┐        ┌──────────┐    │
│   │ OpenAI          │        │ Anthropic   │        │ AI SDK   │    │
│   │ Inbound         │        │ Inbound     │        │ Inbound  │    │
│   └─────────────────┘        └─────────────┘        └──────────┘    │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         中间件处理                                     │
│  - Response Persistence (响应持久化)                                  │
│  - Usage Tracking (使用统计)                                          │
│  - Channel Switching (通道切换，重试时)                               │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      客户端响应 (SSE/JSON)                            │
└─────────────────────────────────────────────────────────────────────┘
```

---

## 相关文件

### 核心接口
- `internal/llm/model.go` - 统一数据模型
- `internal/llm/transformer/interfaces.go` - Transformer 接口
- `internal/llm/pipeline/pipeline.go` - Pipeline 接口
- `internal/llm/pipeline/executor.go` - Executor 接口

### 实现
- `internal/llm/transformer/openai/` - OpenAI Transformer
- `internal/llm/transformer/anthropic/` - Anthropic Transformer
- `internal/llm/transformer/aisdk/` - AI SDK Transformer

### Pipeline
- `internal/llm/pipeline/pipeline.go` - 主 Pipeline 实现
- `internal/llm/pipeline/stream.go` - 流式处理
- `internal/llm/pipeline/retry.go` - 重试逻辑
- `internal/llm/pipeline/middleware.go` - 中间件系统

### 业务逻辑
- `internal/server/chat/` - Chat 处理和持久化
- `internal/server/api/chat.go` - HTTP 处理器
- `internal/server/biz/channel.go` - 通道管理

### 工具
- `internal/pkg/httpclient/` - HTTP 客户端工具
- `internal/pkg/streams/` - 流式工具
- `internal/pkg/retry/` - 重试工具
- `internal/llm/pipeline/pipeline.go` - Pipeline 接口
- `internal/llm/pipeline/executor.go` - Executor 接口

### 实现
- `internal/llm/transformer/openai/` - OpenAI Transformer
- `internal/llm/transformer/anthropic/` - Anthropic Transformer
- `internal/llm/transformer/aisdk/` - AI SDK Transformer

### Pipeline
- `internal/llm/pipeline/pipeline.go` - 主 Pipeline 实现
- `internal/llm/pipeline/stream.go` - 流式处理
- `internal/llm/pipeline/retry.go` - 重试逻辑
- `internal/llm/pipeline/middleware.go` - 中间件系统

### 业务逻辑
- `internal/server/chat/` - Chat 处理和持久化
- `internal/server/api/chat.go` - HTTP 处理器
- `internal/server/biz/channel.go` - 通道管理

### 工具
- `internal/pkg/httpclient/` - HTTP 客户端工具
- `internal/pkg/streams/` - 流式工具
- `internal/pkg/retry/` - 重试工具

---

## 架构图

```
┌─────────────────────────────────────────────────────────────────────┐
│                           客户端请求                                  │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      HTTP Handler (/chat/completion)                  │
│                      文件: internal/server/api/chat.go               │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                       ChatCompletionProcessor                         │
│                      文件: internal/server/chat/completion.go        │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│  InboundTransformer                                                    │
│  文件: internal/server/chat/inbound.go                               │
│  功能: HTTP Request → LLM Request                                    │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬────────────────────────────────┘
                                     │
                                     ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         中间件处理                                     │
│  - Model Mapping (模型名称映射)                                       │
│  - Channel Selection (通道选择)                                       │
│  - MaxToken Enforcement (Token 限制)                                 │
│  - Request Persistence (请求持久化)                                   │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│  OutboundTransformer                                                   │
│  文件: internal/server/chat/outbound.go                              │
│  功能: LLM Request → HTTP Request                                    │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                        LLM Pipeline                                   │
│  文件: internal/llm/pipeline/pipeline.go                             │
│  功能: 执行请求 + 重试逻辑                                              │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│                Transformer (根据通道类型选择)                           │
│                                                                        │
│   ┌─────────────────┐        ┌─────────────────┐        ┌──────────┐│
│   │ OpenAI          │        │ Anthropic       │        │ AI SDK   ││
│   │ Transformers    │        │ Transformers    │        │Transform ││
│   └─────────────────┘        └─────────────────┘        └──────────┘│
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬────────────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      AI 提供商 (OpenAI/Anthropic/...)                 │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┐
│                Transformer (响应转换)                                  │
│                                                                        │
│  LLM Response ←─────────────────────┐                                 │
│                                      │                                │
│   ┌─────────────────┐        ┌──────▼──────┐        ┌──────────┐    │
│   │ OpenAI          │        │ Anthropic   │        │ AI SDK   │    │
│   │ Inbound         │        │ Inbound     │        │ Inbound  │    │
│   └─────────────────┘        └─────────────┘        └──────────┘    │
└ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ┬ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─ ─┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────┐
│                         中间件处理                                     │
│  - Response Persistence (响应持久化)                                  │
│  - Usage Tracking (使用统计)                                          │
│  - Channel Switching (通道切换，重试时)                               │
└──────────────────────────────┬──────────────────────────────────────┘
                               │
                               ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      客户端响应 (SSE/JSON)                            │
└─────────────────────────────────────────────────────────────────────┘
```

---

## Contact & Support

如有问题，请查看：
- `/Users/September_1/Projects/AI/axonhub/internal/llm/` - Transformer 实现
- `/Users/September_1/Projects/AI/axonhub/internal/llm/pipeline/` - Pipeline 核心
- `/Users/September_1/Projects/AI/axonhub/internal/server/chat/` - 业务逻辑
