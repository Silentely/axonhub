// Package responses implements the response API for OpenAI.
package responses

import (
	"encoding/json"
	"fmt"

	"github.com/looplj/axonhub/internal/llm"
	"github.com/looplj/axonhub/internal/llm/transformer"
)

// ImageGeneration is a permissive structure to carry image generation tool
// parameters. It mirrors the OpenRouter/OpenAI Responses API fields we care
// about, but is intentionally loose to allow forward-compatibility.
type ImageGeneration struct {
	llm.ImageGeneration

	Type  string `json:"type"`
	Model string `json:"model"`
}

type Tool struct {
	// Any of "function", "image_generation" nil.
	Type        string `json:"type,omitempty"`
	Name        string `json:"name,omitempty"`
	Description string `json:"description,omitempty"`

	// This field is from variant [FunctionTool].
	Parameters map[string]any `json:"parameters,omitempty"`
	// This field is from variant [FunctionTool].
	Strict *bool `json:"strict,omitempty"`

	// This field is for ImageGeneration
	Background string `json:"background,omitempty"`
	// This field is for ImageGeneration
	InputFidelity string `json:"input_fidelity,omitempty"`
	// This field is for ImageGeneration
	Model string `json:"model,omitempty"`
	// This field is for ImageGeneration
	Moderation string `json:"moderation,omitempty"`
	// This field is for ImageGeneration
	OutputCompression *int64 `json:"output_compression,omitempty"`
	// This field is for ImageGeneration
	OutputFormat string `json:"output_format,omitempty"`
	// This field is for ImageGeneration
	PartialImages *int64 `json:"partial_images,omitempty"`
	// This field is for ImageGeneration
	Quality string `json:"quality,omitempty"`
	// This field is for ImageGeneration
	Size string `json:"size,omitempty"`
}

// Request is a minimal struct for OpenAI Responses API creation.
// Reference: github.com/openai/openai-go/v2/responses.ResponseNewParams
// NOTE: We only include the subset we need to support image generation for now.
type Request struct {
	Model string `json:"model"`

	// A system (or developer) message inserted into the model's context.
	Instructions string `json:"instructions,omitempty"`

	Temperature *float64 `json:"temperature,omitempty"`

	// Input can be a string prompt. We use the last user message extracted.
	Input Input `json:"input"`
	// Tools includes the image_generation tool with params.
	Tools []Tool `json:"tools,omitempty"`
	// Parallel tool calls preference.
	ParallelToolCalls *bool `json:"parallel_tool_calls,omitempty"`
	// Optional fields that we may map from llm.Request if present in future.

	Stream           *bool             `json:"stream,omitempty"`
	Store            *bool             `json:"store,omitempty"`
	ServiceTier      *string           `json:"service_tier,omitempty"`
	SafetyIdentifier *string           `json:"safety_identifier,omitempty"`
	User             *string           `json:"user,omitempty"`
	Metadata         map[string]string `json:"metadata,omitempty"`
	MaxOutputTokens  *int64            `json:"max_tokens,omitempty"`
	MaxToolCalls     *int64            `json:"max_tool_calls,omitempty"`
	Text             *TextOptions      `json:"text,omitempty"`
}

type TextOptions struct {
	// An object specifying the format that the model must output.
	// Configuring { "type": "json_schema" } enables Structured Outputs, which ensures the model will match your supplied JSON schema. Learn more in the Structured Outputs
	// guide.
	// The default format is { "type": "text" } with no additional options.
	// { "type": "json_object" } is also supported.
	Format string          `json:"format,omitempty"`
	Name   string          `json:"name,omitempty"`
	Schema json.RawMessage `json:"schema,omitempty"`
}

type Input struct {
	Text  *string
	Items []Item
}

func (i *Input) UnmarshalJSON(data []byte) error {
	var text string
	if err := json.Unmarshal(data, &text); err == nil {
		i.Text = &text
		return nil
	}

	var items []Item
	if err := json.Unmarshal(data, &items); err == nil {
		i.Items = items
		return nil
	}

	return fmt.Errorf("invalid input: %w", transformer.ErrInvalidRequest)
}

func (i Input) MarshalJSON() ([]byte, error) {
	if i.Text != nil {
		return json.Marshal(i.Text)
	}

	return json.Marshal(i.Items)
}

type Item struct {
	// The ID of the item, generated by the server.
	ID string `json:"id"`

	// Any of "message", "input_image", "output_text", "image_generation_call".
	Type string `json:"type"`
	// Any of "system", "user", "assistant", "developer".
	Role string `json:"role"`
	// The content of the message.
	Content *Input `json:"content"`

	// Status of the item.
	// Any of "in_progress", "completed", "incomplete".
	Status *string `json:"status,omitempty"`

	// The URL of the image url or base64 encoded image, for input_image type.
	ImageURL *string `json:"image_url,omitempty"`

	// The detail of the image. high, low, or auto, for input_image type.
	Detail *string `json:"detail,omitempty"`

	// Text for output_text type.
	Text *string `json:"text,omitempty"`

	// Result for image_generation_call type.
	Result *string `json:"result,omitempty"`
}

type Response struct {
	Object      string       `json:"object"`
	ID          string       `json:"id"`
	Error       *Error       `json:"error,omitempty"`
	CreatedAt   int64        `json:"created_at"`
	Model       string       `json:"model"`
	Output      []OutputItem `json:"output"`
	ServiceTier *string      `json:"service_tier,omitempty"`

	// Status of the response.
	// Any of "completed", "failed", "in_progress", "canceled", "queued", or "incomplete".
	Status *string `json:"status,omitempty"`

	Usage *Usage `json:"usage,omitempty"`
}

type OutputItem struct {
	// The ID of the item, generated by the server.
	ID string `json:"id"`

	// Any of "message", "input_image", "output_text", "image_generation_call".
	Type string `json:"type"`
	// Any of "system", "user", "assistant", "developer".
	Role string `json:"role"`

	// Status of the item.
	// Any of "in_progress", "completed", "incomplete".
	Status *string `json:"status,omitempty"`

	// Content for message type items
	Content []ContentItem `json:"content,omitempty"`

	// The URL of the image url or base64 encoded image, for input_image type.
	ImageURL *string `json:"image_url,omitempty"`

	// The detail of the image. high, low, or auto, for input_image type.
	Detail *string `json:"detail,omitempty"`

	// Text for output_text type.
	Text *string `json:"text,omitempty"`

	// Result for image_generation_call type.
	Result *string `json:"result,omitempty"`
}

type ContentItem struct {
	Type        string   `json:"type"`
	Text        string   `json:"text,omitempty"`
	Annotations []string `json:"annotations,omitempty"`
}

type Error struct {
	Code    int    `json:"code"`
	Message string `json:"message"`
}
